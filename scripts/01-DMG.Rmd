---
title: "Identifying differentially methylated genes"
author: "EL Strand"
output:
  github_document: default
  pdf_document:
    keep_tex: yes
  html_document:
    toc: yes
    toc_depth: 6
    toc_float: yes
editor_options: 
  chunk_output_type: inline
---

# Differentially Methylated Genes 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Input from this script: https://github.com/emmastrand/EmmaStrand_Notebook/blob/master/_posts/2021-10-21-KBay-Bleaching-Pairs-WGBS-Analysis-Pipeline.md#kbay-wgbs-methylation-analysis-pipeline

I'm following Hollie Putnam and Kevin Wong's pipelines. 
- https://github.com/kevinhwong1/Thermal_Transplant_Molecular/blob/main/scripts/WGBS_GM.Rmd

## Load libraries 

https://github.com/hputnam/Geoduck_Meth/blob/master/RAnalysis/Scripts/GM.Rmd

```{r, message=FALSE, warning=FALSE}

# BiocManager::install("goseq")

library(plyr)
library(dplyr)
library(ggplot2)
library(tidyverse)
library(readxl)
library(plotrix) 
library(gridExtra)
library(seacarb) 
library(pheatmap)
library(tidyr)
library(gplots)
library(cowplot)
library(lsmeans)
library(data.table)
library(RColorBrewer)
library(randomcoloR)
#library(GSEABase)
library(ggpubr)
library(hrbrthemes)
library(viridis)
library(factoextra)
#library(ropls)
#library(mixOmics)
library(vegan)
library(Rmisc)
```

## Load DNA methylation files 

Below commands were only run use to produce data file and then not run again for computational purposes.

```{r}
# meth5x <- list.files(path = "data/WGBS/output/meth_counts_5x", 
#                      pattern = ".bed$", full.names=TRUE) %>% set_names(.) %>%
#   map_dfr(read.csv,.id="Sample.ID", header=FALSE, sep="\t", na.string="NA", stringsAsFactors = FALSE) %>%
#   dplyr::select(-c(V3,V7:V14)) 
# 
# colnames(meth5x) <- c("Sample.ID", "scaffold", "position","per.meth","meth","unmeth","gene")
# meth5x$gene <- gsub("ID=","",meth5x$gene) #remove extra characters
# meth5x$gene <- gsub("Parent=","",meth5x$gene) #remove extra characters
# meth5x$Sample.ID <- gsub("data/WGBS/output/meth_counts_5x/","",meth5x$Sample.ID) #remove extra characters
# meth5x$Sample.ID <- gsub("_5x_sorted.tab_gene_CpG_5x_enrichment.bed","",meth5x$Sample.ID) #remove extra characters 
# meth5x$Sample.ID <- as.character(meth5x$Sample.ID)
```

Load df created in code above 

```{r}
load("data/WGBS/meth5x.RData")
```

### Metadata files 

```{r}
meta <- read.csv("data/metadata/Molecular_metadata.csv") %>%
  mutate(Timepoint = if_else(Plug_ID == "2153", "12 hour", Timepoint)) %>%
  dplyr::rename(Sample.ID = Plug_ID) %>% 
  dplyr::select(Sample.ID, Species, Tank, Treatment, Temperature, CO2, Timepoint, Sample.Date) 
  
meta$Sample.ID <- as.character(meta$Sample.ID)

meta$Timepoint <- factor(meta$Timepoint, 
                           levels = c("0 hour", "6 hour", "12 hour", "30 hour",
                                      "1 week", "2 week", "4 week", "6 week",
                                      "8 week", "12 week", "16 week"))

pacuta_clade <- read.delim2("data/metadata/clade_annotations_Pacuta.txt", header = TRUE, sep="\t") %>%
  separate(., Sample, c("Species", "Treatment", "Timepoint", "Sample.ID")) %>% 
  dplyr::select(-Treatment, -Timepoint) %>% dplyr::select(Sample.ID, Clade)

ploidyinfo <- read.delim2("data/metadata/samples_Pacuta.annotations.txt", 
                          header=TRUE, sep="\t", na.strings=c("","NA")) %>% 
  dplyr::rename(., Sample.ID = plugid) %>% 
  mutate_if(is.integer, as.character) %>% 
  dplyr::select(Sample.ID, ploidy, group, treesplit) %>%
  #mutate(treesplit = coalesce(treesplit, "D")) %>% 
  #changing NA values to "D" in treesplit -- this is just so triploidy is split in 2 groups and diploidy is altogether 
  left_join(., pacuta_clade, by="Sample.ID")

meta <- dplyr::left_join(meta, ploidyinfo, by="Sample.ID")
save(meta, file = "data/metadata/meta.RData")
```

### Merge dataframes together

```{r}
df5x <- full_join(meth5x, meta, by = "Sample.ID") %>%
  mutate(meth_exp_group = case_when(
    group == "Group1" ~ "T1",
    group == "Group2" ~ "T1",
    group == "Group3" ~ "T2",
    group == "Group4" ~ "T2",
    group == "Group5" ~ "D",
    group == "Group6" ~ "D",
    group == "Group7" ~ "ungroup",
    group == "Ungroup" ~ "ungroup")) %>% 
  subset(!group == "Group7" & !group == "Ungroup") %>%
  filter(!Sample.ID == "1225") %>% 
  filter(!Sample.ID == "2197") 

df5x %>% 
  dplyr::select(Sample.ID, meth_exp_group, per.meth) %>% 
  filter(!is.na(per.meth)) %>% dplyr::select(-per.meth) %>%
  filter(!Sample.ID == "1225") %>% 
  filter(!Sample.ID == "2197") %>%
  distinct() %>% write.csv("data/metadata/meth_pattern_groups.csv")
```

## Binomial GLM to test for differentially methylated genes

### Filter for genes with >5 methylated positions

Come back to this value of a cut off of 5 methylated positions per gene. 

```{r}
meth_table5x <- df5x
meth_table5x$sample_gene <- paste0(meth_table5x$Sample.ID, meth_table5x$gene)
```

```{r}
meth_table5x_position_counts <- dplyr::count(meth_table5x, vars = c(sample_gene))
meth_table5x_position_counts <- meth_table5x_position_counts[which(meth_table5x_position_counts$n > 5), ]

meth_table5x_filtered <- meth_table5x[meth_table5x$sample_gene %in% meth_table5x_position_counts$vars,]
```

### Run loop for GLM 

Create data frame to store results

```{r}
results5x <- data.frame()
```

First subset the unique dataframes and second run the GLMs

```{r}
gs5x <- unique(meth_table5x_filtered$gene)
```

#### 5x loop

```{r}
# for(i in 1:length(meth_table5x_filtered$gene)){
#     
#     #subset the dataframe gene by gene
#     meth_table_filt1 <- subset(meth_table5x_filtered, gene ==gs5x[1])
#     
#     # fit glm position model
#     fit2 <- glm(matrix(c(meth, unmeth), ncol=2) ~ meth_exp_group, 
#                data=meth_table_filt1, family=binomial)
#     a2 <- anova(fit2, test="LRT")
# 
#     # capture summary stats to data frame
#     df2 <- data.frame(gene = meth_table_filt1[1,7], ###for treesplit [1,8] or at least double check this
#                      pval.methgroup = a2$`Pr(>Chi)`[2],
#                      stringsAsFactors = F)
#     # bind rows of temporary data frame to the results data frame
#     results5x <- rbind(results5x, df2)
# }
```

Export df created. Run the read.csv() function below the export code to read back in those df. When running the script multiple times, you don't need to run the binomial function above. Skip that code and just read in results5x or 10x df. 

```{r}
#results5x %>% write.csv("data/WGBS/results5x_methgroup.csv") #9,647 genes - this should match length of gs5x

results5x <- read.csv("data/WGBS/results5x_methgroup.csv", header = TRUE) %>% 
  dplyr::select(-X) %>% distinct() ## distinct() necessary in case the model above went through multiple times
```

Some genes return the error: `"glm.fit: fitted probabilities numerically 0 or 1 occurredglm.fit: fitted probabilities numerically 0 or 1". These will be filtered out of analysis later on` and `Error in `contrasts<-`(`*tmp*`, value = contr.funs[1 + isOF[nn]]) : contrasts can be applied only to factors with 2 or more levels`. 

## Calculating adjusted p-values for glm

```{r}
results5x[is.na(results5x)] <- 0
results5x$adj.pval.methgroup <- p.adjust(results5x$pval.methgroup, method='BH')
```

### subsetting new df to only those adjusted p value columns 

methgroup: 3,870 genes significantly DMG out of 9,467 genes that had at least 5 methylated positions and appeared in all samples.

```{r}
DMG_5x_sig <- results5x %>%
  dplyr::select(gene, adj.pval.methgroup) %>% 
  mutate(across(2, round, 8)) %>%
  filter(adj.pval.methgroup < 0.050) 

nrow(DMG_5x_sig) # 3,870 for methgroup

DMG_5x_sig %>% write.csv("data/WGBS/DMG_5x_sig_methgroup.csv")
```

#### Dataframes at this point 

- `eggNOGG` = original gene annotation file 
- `OE` = output from CpG OE script with weakly and heavily methylated gene sets 
- `gene_meta` = merged metadata of genes 
- `df5x / df10x` = .bed files and metadata together
- `meth_table5x_filtered / meth_table10x_filtered` = output from filtering all genes with 5+ methylated positions; input for the glm model
- `gs5x / gs10x` = list of unique genes from filtered methylation table  
- `results5x / results10x` = output from glm model; contains gene names, pvalues and adjusted pvalues for differentially methylated  
- `DMG_5x_sig / DMG_5x_sig` = only adjusted pvalues from the results 5 and 10x dfs 


```{r}
meth_table5x_filtered <- meth_table5x_filtered %>% 
  mutate(loci_status = case_when(
          per.meth <= 10 ~ "unmethylated",
          per.meth > 10 & per.meth < 50 ~ "sparsely methylated",
          per.meth >= 50 ~ "methylated"))

## hist for per.meth distribution for DMGs
meth_table5x_filtered_sigDMG <- meth_table5x_filtered[meth_table5x_filtered$gene %in% DMG_5x_sig$gene,]
```

## Methylation level calculations  

### GENERAL HISTOGRAM OF CPG LOCI METHYLATION LEVEL

```{r}
### number of loci per sample = 103,629 unique loci for all; 44,366 for sig DMG
## sample size of D = 16; T1=20; T2=17 

#### GENERAL HISTOGRAM OF CPG LOCI METHYLATION LEVEL 
## hist for per.meth distribution for all genes
histall <- meth_table5x_filtered %>%
  ggplot(aes(x=per.meth, fill=meth_exp_group)) + theme_bw() +
  facet_grid(factor(loci_status, levels=c('unmethylated','sparsely methylated','methylated'))~meth_exp_group, scales="free") +
  geom_histogram(alpha=0.6, position = 'identity') +
  scale_fill_manual(values=c("skyblue3", "olivedrab4", "darkgreen")) +
  labs(fill="") +
  theme(strip.text.x = element_text(size = 12, color = "black", face = "bold"),
        strip.text.y = element_text(size = 12, color = "black", face = "bold")) +
  theme(strip.background = element_rect(color="black", fill="white", linewidth=0.5, linetype="solid"))

ggsave(filename="data/figures/Loci_Percent_methylation_all.jpeg", width=8, height=7, units="in")

## hist for per.meth distribution for significant DMGs 
histDMG <- meth_table5x_filtered_sigDMG %>%
  ggplot(aes(x=per.meth, fill=meth_exp_group)) + theme_bw() +
  facet_grid(factor(loci_status, levels=c('unmethylated','sparsely methylated','methylated'))~meth_exp_group, scales="free") +
  geom_histogram(alpha=0.6, position = 'identity') +
  scale_fill_manual(values=c("skyblue3", "olivedrab4", "darkgreen")) +
  labs(fill="") +
  theme(strip.text.x = element_text(size = 12, color = "black", face = "bold"),
        strip.text.y = element_text(size = 12, color = "black", face = "bold")) +
  theme(strip.background = element_rect(color="black", fill="white", linewidth=0.5, linetype="solid"))

ggsave(filename="data/figures/Loci_Percent_methylation_sigDMGs.jpeg", width=8, height=7, units="in")

##### without unmethylated 
histun <- meth_table5x_filtered %>%
  filter(!loci_status == "unmethylated") %>%
  ggplot(aes(x=per.meth, fill=meth_exp_group)) + theme_bw() +
  facet_grid(~meth_exp_group, scales="free") +
  geom_histogram(alpha=0.6, position = 'identity') +
  scale_fill_manual(values=c("skyblue3", "olivedrab4", "darkgreen")) +
  labs(fill="") +
  theme(strip.text.x = element_text(size = 12, color = "black", face = "bold"),
        strip.text.y = element_text(size = 12, color = "black", face = "bold")) +
  theme(strip.background = element_rect(color="black", fill="white", linewidth=0.5, linetype="solid"))

ggsave(filename="data/figures/Loci_Percent_methylation_filtered.jpeg", width=6, height=3, units="in")
```

### Filtering out loci with zero's 

Filter out loci that have median < 10% across all samples. 

meth_table5x_filtered = 5,346,733 loci 
meth_table5x_filtered_sigDMG = 2,278,227 loci

meth_table5x_filtered2 = 229,661 loci in 1,976 genes (4,503 loci per sample)
meth_table5x_filtered2_sigDMG =  198,647 loci in 1,447 genes (3,895 loci per sample)

```{r}
meth_table5x_filtered2 <- meth_table5x_filtered %>% group_by(position) %>%
  mutate(position.median = median(per.meth)) %>%
  filter(!position.median < 10) %>% ungroup()

## viewing one loci to see if the above function worked 
meth_table5x_filtered2 %>% filter(position == "3396")
meth_table5x_filtered %>% filter(position == "3396")

meth_table5x_filtered2_sigDMG <- meth_table5x_filtered2[meth_table5x_filtered2$gene %in% DMG_5x_sig$gene,]
length(unique(meth_table5x_filtered2_sigDMG$gene)) ##1,447 genes left 

save(meth_table5x_filtered_sigDMG, file = "data/WGBS/meth_table5x_filtered_sigDMG.RData")
save(meth_table5x_filtered, file = "data/WGBS/meth_table5x_filtered.RData")
save(meth_table5x_filtered2, file = "data/WGBS/meth_table5x_filtered2.RData")
save(meth_table5x_filtered2_sigDMG, file = "data/WGBS/meth_table5x_filtered2_sigDMG.RData")
```

